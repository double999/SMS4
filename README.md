# SM4 Sbox 塔域实现
本项目完成了国密算法SM4中S盒的硬件实现
实现方法为同构同构映射矩阵，将求逆运算最终转化到GF(2)上进行，比直接用查找表实现节省面积
适合面积限制型的应用

代数表达式：

$$Sbox(a)=I\left(x \cdot \mathbf{A}_{1}+C_{1}\right) \cdot \mathbf{A}_{2}+C_{2}$$

其中：

$$
C_{1}=C_{2}=(1,1,0,0,1,0,1,1)
$$

$$
\mathbf{A}_{1}=\mathbf{A}_{2}=\begin{bmatrix} 1 & 1 & 1 & 0 & 0&1&0&1\\ 1 & 1 &1 &1 &0 &0 &1 &0 \\0&1&1&1&1&0&0&1\\ 1&0&1&1&1&1&0&0\\0&1&0&1&1&1&1&0\\0&0&1&0&1&1&1&1\\1&0&0&1&0&1&1&1\\1&1&0&0&1&0&1&1 \end{bmatrix}\quad
$$

$I$ 为$G F\left(2^{8}\right)$域上的求逆，SM4算法使用的不可约多项式为：

$$
M(x)=x^{8}+x^{7}+x^{6}+x^{5}+x^{4}+x^{2}+1
$$


## 2019-04-18更新
整体的实现方案在参考的一篇博士论文中已经写的很详细了，所以本来应该是一次很简单的硬件实现项目。

**但是**，逻辑仿真的时候，发现代数式怎么都和S盒对不上！又倒回matlab做代数式的仿真。

**结果**，matlab仿真发现，即使不通过同构映射转换到塔域，这个代数式还是对不上S盒。各种查阅文献，所有给出的代数式都是一样的，仿射变换的矩阵也是一样的。

仿佛就跟发现了“学术腐败坑”一样，这么多人，不能同时造假吧？！可是我确实又复现不出来。。。

拖了几天后，终于发现了篇文章，给出了S盒的[代数C代码](https://blog.csdn.net/qq_36291381/article/details/80156315)（别误会，不是查找表实现）。
问题出在下式：

$$
C_{1}=C_{2}=(1,1,0,0,1,0,1,1)
$$

应该**修改为**

$$
C_{1}=C_{2}=(1,1,0,1,0,0,1,1)
$$

这个仿射变换的C，应该换一下二进制顺序。。。真是太坑了有没有。。。而且所有的文献都是直接给出一个代数式，丝毫没有说明下列问题：
1. x输入矢量是MSB_first还是LSB_first
2. 中间运算转到塔域求逆时，行向量转置为列向量，是MSB_first还是LSB_first？

总是很多模糊不定的问题，让我试来试去。。。很烦
## 最终版本

其中.c文件为代数式的C实现，并没有涉及到塔域变换。

Sbox_top为顶层模块。输入8位,MSB_first，输出8位，MSB_first。

各个子模块的实现均是通过代数推导得到的结构，可以参考caj文件第三章，写得很详细。

其中将仿射变换和同构映射的矩阵运算结合到了一块，所以通过代码是看不到任何中间过程的。

代码没有行为性的描述，都是基于数学推导得出的布尔表达式写的。
